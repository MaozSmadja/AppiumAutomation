'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumIosSimulator = require('appium-ios-simulator');

var _server = require('../server');

var commands = {},
    helpers = {},
    extensions = {};

commands.execute = function callee$0$0(script, args) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!script.match(/^mobile\:/)) {
          context$1$0.next = 7;
          break;
        }

        script = script.replace(/^mobile\:/, '').trim();
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeMobile(script, _lodash2['default'].isArray(args) ? args[0] : args));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        if (!this.isWebContext()) {
          context$1$0.next = 14;
          break;
        }

        args = this.convertElementsForAtoms(args);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, args]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeAsync = function callee$0$0(script, args, sessionId) {
  var address, port, protocol, currentUrl, responseUrl, defaultHost, urlObject;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;

        sessionId = sessionId || this.sessionId;

        // https sites need to reply to an https endpoint, in Safari
        protocol = 'http:';
        context$1$0.prev = 8;
        context$1$0.t0 = _url2['default'];
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.getUrl());

      case 12:
        context$1$0.t1 = context$1$0.sent;
        currentUrl = context$1$0.t0.parse.call(context$1$0.t0, context$1$0.t1);

        if (currentUrl.protocol === 'https:' && this.opts.httpsCallbackPort && this.opts.httpsCallbackAddress) {
          protocol = currentUrl.protocol;
          port = this.opts.httpsCallbackPort;
          address = this.opts.httpsCallbackAddress;
        }
        context$1$0.next = 19;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t2 = context$1$0['catch'](8);

      case 19:
        responseUrl = protocol + '//' + address + ':' + port + '/wd/hub/session/' + sessionId + '/receive_async_response';

        if (this.isRealDevice()) {
          defaultHost = this.opts.address;
          urlObject = _url2['default'].parse(responseUrl);

          if (urlObject.hostname === defaultHost) {
            _logger2['default'].debug('Real device safari test and no custom callback address ' + 'set, changing callback address to local ip.');
            urlObject.hostname = _appiumSupport.util.localIp();
            urlObject.host = null; // set to null, otherwise hostname is ignored
            responseUrl = _url2['default'].format(urlObject);
          } else {
            _logger2['default'].debug('Custom callback address set, leaving as is.');
          }
        }

        _logger2['default'].debug('Response url for executeAsync: ' + responseUrl);
        args = this.convertElementsForAtoms(args);
        this.asyncWaitMs = this.asyncWaitMs || 0;
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(this.executeAtomAsync('execute_async_script', [script, args, this.asyncWaitMs], responseUrl));

      case 26:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 27:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 17]]);
};

commands.receiveAsyncResponse = function callee$0$0(status, value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received async response: ' + JSON.stringify(value));

        if (_appiumSupport.util.hasValue(this.asyncPromise)) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].warn('Received async response when we were not expecting one! ' + ('Response was: ' + JSON.stringify(value)));
        return context$1$0.abrupt('return');

      case 4:
        if (!(_appiumSupport.util.hasValue(status) && status !== 0)) {
          context$1$0.next = 6;
          break;
        }

        return context$1$0.abrupt('return', this.asyncPromise.reject((0, _appiumBaseDriver.errorFromCode)(status, value.message)));

      case 6:
        if (!(!_appiumSupport.util.hasValue(status) && value && _lodash2['default'].isString(value.error))) {
          context$1$0.next = 8;
          break;
        }

        return context$1$0.abrupt('return', this.asyncPromise.reject((0, _appiumBaseDriver.errorFromW3CJsonCode)(value.error, value.message, value.stacktrace)));

      case 8:
        return context$1$0.abrupt('return', this.asyncPromise.resolve(value));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.startHttpsAsyncServer = function callee$0$0() {
  var address, port, _ref, sslServer, pemCertificate, httpsPort, udid;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Starting https server for async responses');
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _server.startHttpsServer)(port, address));

      case 5:
        _ref = context$1$0.sent;
        sslServer = _ref.sslServer;
        pemCertificate = _ref.pemCertificate;
        httpsPort = _ref.httpsPort;

        this.opts.sslServer = sslServer;
        this.opts.httpsServerCertificate = pemCertificate;
        this.opts.httpsCallbackPort = httpsPort;
        this.opts.httpsCallbackAddress = 'localhost';
        udid = undefined;

        if (this.sim) {
          // ios driver
          udid = this.sim.udid;
        } else {
          // xcuitest driver
          udid = this.opts.udid;
        }
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.httpsServerCertificate, udid));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopHttpsAsyncServer = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Stopping https server for async responses');

        if (!this.opts.sslServer) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.opts.sslServer.close());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.httpsServerCertificate, this.opts.udid));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeMobile = function callee$0$0(mobileCommand) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(mobileCommand === 'scroll')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll(opts));

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!(mobileCommand === 'viewportScreenshot')) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.getViewportScreenshot());

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
        throw new _appiumBaseDriver.errors.UnknownCommandError('Unknown command, all the mobile commands except scroll have been removed.');

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// MJSONWP

// W3C

// we only support mobile: scroll
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBNEQsb0JBQW9COztzQkFDbEUsUUFBUTs7OzttQkFDTixLQUFLOzs7OzZCQUNBLGdCQUFnQjs7c0JBQ2xCLFdBQVc7Ozs7a0NBQ21CLHNCQUFzQjs7c0JBQ3RDLFdBQVc7O0FBRzVDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxPQUFPLEdBQUcsb0JBQWdCLE1BQU0sRUFBRSxJQUFJOzs7O2FBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDOzs7OztBQUMzQixjQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7O3lDQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQzs7Ozs7O2FBRXJFLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O0FBQ3JCLFlBQUksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7O3lDQUM3QixJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOzs7Ozs7O3lDQUVsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FHdkQsQ0FBQzs7QUFFRixRQUFRLENBQUMsWUFBWSxHQUFHLG9CQUFnQixNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVM7TUFLekQsT0FBTyxFQUNQLElBQUksRUFJSixRQUFRLEVBRU4sVUFBVSxFQU9aLFdBQVcsRUFHVCxXQUFXLEVBQ1gsU0FBUzs7OztZQXRCVixJ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O3lDQUNLLHdDQUFlLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDOzs7Ozs7O0NBQzdELENBQUM7O0FBRUYsT0FBTyxDQUFDLG9CQUFvQixHQUFHOzs7O0FBQzdCLDRCQUFPLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDOzthQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7Ozs7Ozt5Q0FDZixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7Ozs7eUNBRTdCLDBDQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0NBQ3pFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRyxvQkFBZ0IsYUFBYTtNQUFFLElBQUkseURBQUMsRUFBRTs7OztjQUV6RCxhQUFhLEtBQUssUUFBUSxDQUFBOzs7Ozs7eUNBQ3RCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDOzs7Ozs7O2NBQ3BCLGFBQWEsS0FBSyxvQkFBb0IsQ0FBQTs7Ozs7O3lDQUNsQyxJQUFJLENBQUMscUJBQXFCLEVBQUU7Ozs7OztjQUVuQyxJQUFJLHlCQUFPLG1CQUFtQixDQUFDLDJFQUEyRSxDQUFDOzs7Ozs7O0NBRXBILENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZXhlY3V0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycywgZXJyb3JGcm9tQ29kZSwgZXJyb3JGcm9tVzNDSnNvbkNvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBpbnN0YWxsU1NMQ2VydCwgdW5pbnN0YWxsU1NMQ2VydCB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IHN0YXJ0SHR0cHNTZXJ2ZXIgfSBmcm9tICcuLi9zZXJ2ZXInO1xuXG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuZXhlY3V0ZSA9IGFzeW5jIGZ1bmN0aW9uIChzY3JpcHQsIGFyZ3MpIHtcbiAgaWYgKHNjcmlwdC5tYXRjaCgvXm1vYmlsZVxcOi8pKSB7XG4gICAgc2NyaXB0ID0gc2NyaXB0LnJlcGxhY2UoL15tb2JpbGVcXDovLCAnJykudHJpbSgpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVNb2JpbGUoc2NyaXB0LCBfLmlzQXJyYXkoYXJncykgPyBhcmdzWzBdIDogYXJncyk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgIGFyZ3MgPSB0aGlzLmNvbnZlcnRFbGVtZW50c0ZvckF0b21zKGFyZ3MpO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW3NjcmlwdCwgYXJnc10pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoc2NyaXB0KTtcbiAgICB9XG4gIH1cbn07XG5cbmNvbW1hbmRzLmV4ZWN1dGVBc3luYyA9IGFzeW5jIGZ1bmN0aW9uIChzY3JpcHQsIGFyZ3MsIHNlc3Npb25JZCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoc2NyaXB0KTtcbiAgfVxuXG4gIGxldCBhZGRyZXNzID0gdGhpcy5vcHRzLmNhbGxiYWNrQWRkcmVzcyB8fCB0aGlzLm9wdHMuYWRkcmVzcztcbiAgbGV0IHBvcnQgPSB0aGlzLm9wdHMuY2FsbGJhY2tQb3J0IHx8IHRoaXMub3B0cy5wb3J0O1xuICBzZXNzaW9uSWQgPSBzZXNzaW9uSWQgfHwgdGhpcy5zZXNzaW9uSWQ7XG5cbiAgLy8gaHR0cHMgc2l0ZXMgbmVlZCB0byByZXBseSB0byBhbiBodHRwcyBlbmRwb2ludCwgaW4gU2FmYXJpXG4gIGxldCBwcm90b2NvbCA9ICdodHRwOic7XG4gIHRyeSB7XG4gICAgbGV0IGN1cnJlbnRVcmwgPSB1cmwucGFyc2UoYXdhaXQgdGhpcy5nZXRVcmwoKSk7XG4gICAgaWYgKGN1cnJlbnRVcmwucHJvdG9jb2wgPT09ICdodHRwczonICYmIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydCAmJiB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja0FkZHJlc3MpIHtcbiAgICAgIHByb3RvY29sID0gY3VycmVudFVybC5wcm90b2NvbDtcbiAgICAgIHBvcnQgPSB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja1BvcnQ7XG4gICAgICBhZGRyZXNzID0gdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tBZGRyZXNzO1xuICAgIH1cbiAgfSBjYXRjaCAoaWduKSB7fVxuICBsZXQgcmVzcG9uc2VVcmwgPSBgJHtwcm90b2NvbH0vLyR7YWRkcmVzc306JHtwb3J0fS93ZC9odWIvc2Vzc2lvbi8ke3Nlc3Npb25JZH0vcmVjZWl2ZV9hc3luY19yZXNwb25zZWA7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsZXQgZGVmYXVsdEhvc3QgPSB0aGlzLm9wdHMuYWRkcmVzcztcbiAgICBsZXQgdXJsT2JqZWN0ID0gdXJsLnBhcnNlKHJlc3BvbnNlVXJsKTtcbiAgICBpZiAodXJsT2JqZWN0Lmhvc3RuYW1lID09PSBkZWZhdWx0SG9zdCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdSZWFsIGRldmljZSBzYWZhcmkgdGVzdCBhbmQgbm8gY3VzdG9tIGNhbGxiYWNrIGFkZHJlc3MgJyArXG4gICAgICAgICAgICAgICAgICAgJ3NldCwgY2hhbmdpbmcgY2FsbGJhY2sgYWRkcmVzcyB0byBsb2NhbCBpcC4nKTtcbiAgICAgIHVybE9iamVjdC5ob3N0bmFtZSA9IHV0aWwubG9jYWxJcCgpO1xuICAgICAgdXJsT2JqZWN0Lmhvc3QgPSBudWxsOyAvLyBzZXQgdG8gbnVsbCwgb3RoZXJ3aXNlIGhvc3RuYW1lIGlzIGlnbm9yZWRcbiAgICAgIHJlc3BvbnNlVXJsID0gdXJsLmZvcm1hdCh1cmxPYmplY3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0N1c3RvbSBjYWxsYmFjayBhZGRyZXNzIHNldCwgbGVhdmluZyBhcyBpcy4nKTtcbiAgICB9XG4gIH1cblxuICBsb2dnZXIuZGVidWcoYFJlc3BvbnNlIHVybCBmb3IgZXhlY3V0ZUFzeW5jOiAke3Jlc3BvbnNlVXJsfWApO1xuICBhcmdzID0gdGhpcy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyhhcmdzKTtcbiAgdGhpcy5hc3luY1dhaXRNcyA9IHRoaXMuYXN5bmNXYWl0TXMgfHwgMDtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b21Bc3luYygnZXhlY3V0ZV9hc3luY19zY3JpcHQnLCBbc2NyaXB0LCBhcmdzLCB0aGlzLmFzeW5jV2FpdE1zXSwgcmVzcG9uc2VVcmwpO1xufTtcblxuY29tbWFuZHMucmVjZWl2ZUFzeW5jUmVzcG9uc2UgPSBhc3luYyBmdW5jdGlvbiAoc3RhdHVzLCB2YWx1ZSkge1xuICBsb2dnZXIuZGVidWcoYFJlY2VpdmVkIGFzeW5jIHJlc3BvbnNlOiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRoaXMuYXN5bmNQcm9taXNlKSkge1xuICAgIGxvZ2dlci53YXJuKGBSZWNlaXZlZCBhc3luYyByZXNwb25zZSB3aGVuIHdlIHdlcmUgbm90IGV4cGVjdGluZyBvbmUhIGAgK1xuICAgICAgYFJlc3BvbnNlIHdhczogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUoc3RhdHVzKSAmJiBzdGF0dXMgIT09IDApIHtcbiAgICAvLyBNSlNPTldQXG4gICAgcmV0dXJuIHRoaXMuYXN5bmNQcm9taXNlLnJlamVjdChlcnJvckZyb21Db2RlKHN0YXR1cywgdmFsdWUubWVzc2FnZSkpO1xuICB9XG4gIGlmICghdXRpbC5oYXNWYWx1ZShzdGF0dXMpICYmIHZhbHVlICYmIF8uaXNTdHJpbmcodmFsdWUuZXJyb3IpKSB7XG4gICAgLy8gVzNDXG4gICAgcmV0dXJuIHRoaXMuYXN5bmNQcm9taXNlLnJlamVjdChlcnJvckZyb21XM0NKc29uQ29kZSh2YWx1ZS5lcnJvciwgdmFsdWUubWVzc2FnZSwgdmFsdWUuc3RhY2t0cmFjZSkpO1xuICB9XG4gIHJldHVybiB0aGlzLmFzeW5jUHJvbWlzZS5yZXNvbHZlKHZhbHVlKTtcbn07XG5cbmhlbHBlcnMuc3RhcnRIdHRwc0FzeW5jU2VydmVyID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2dnZXIuZGVidWcoJ1N0YXJ0aW5nIGh0dHBzIHNlcnZlciBmb3IgYXN5bmMgcmVzcG9uc2VzJyk7XG4gIGxldCBhZGRyZXNzID0gdGhpcy5vcHRzLmNhbGxiYWNrQWRkcmVzcyB8fCB0aGlzLm9wdHMuYWRkcmVzcztcbiAgbGV0IHBvcnQgPSB0aGlzLm9wdHMuY2FsbGJhY2tQb3J0IHx8IHRoaXMub3B0cy5wb3J0O1xuICBsZXQge3NzbFNlcnZlciwgcGVtQ2VydGlmaWNhdGUsIGh0dHBzUG9ydH0gPSBhd2FpdCBzdGFydEh0dHBzU2VydmVyKHBvcnQsIGFkZHJlc3MpO1xuICB0aGlzLm9wdHMuc3NsU2VydmVyID0gc3NsU2VydmVyO1xuICB0aGlzLm9wdHMuaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSA9IHBlbUNlcnRpZmljYXRlO1xuICB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja1BvcnQgPSBodHRwc1BvcnQ7XG4gIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrQWRkcmVzcyA9ICdsb2NhbGhvc3QnO1xuICBsZXQgdWRpZDtcbiAgaWYgKHRoaXMuc2ltKSB7XG4gICAgLy8gaW9zIGRyaXZlclxuICAgIHVkaWQgPSB0aGlzLnNpbS51ZGlkO1xuICB9IGVsc2Uge1xuICAgIC8vIHhjdWl0ZXN0IGRyaXZlclxuICAgIHVkaWQgPSB0aGlzLm9wdHMudWRpZDtcbiAgfVxuICBhd2FpdCBpbnN0YWxsU1NMQ2VydCh0aGlzLm9wdHMuaHR0cHNTZXJ2ZXJDZXJ0aWZpY2F0ZSwgdWRpZCk7XG59O1xuXG5oZWxwZXJzLnN0b3BIdHRwc0FzeW5jU2VydmVyID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2dnZXIuZGVidWcoJ1N0b3BwaW5nIGh0dHBzIHNlcnZlciBmb3IgYXN5bmMgcmVzcG9uc2VzJyk7XG4gIGlmICh0aGlzLm9wdHMuc3NsU2VydmVyKSB7XG4gICAgYXdhaXQgdGhpcy5vcHRzLnNzbFNlcnZlci5jbG9zZSgpO1xuICB9XG4gIGF3YWl0IHVuaW5zdGFsbFNTTENlcnQodGhpcy5vcHRzLmh0dHBzU2VydmVyQ2VydGlmaWNhdGUsIHRoaXMub3B0cy51ZGlkKTtcbn07XG5cbmNvbW1hbmRzLmV4ZWN1dGVNb2JpbGUgPSBhc3luYyBmdW5jdGlvbiAobW9iaWxlQ29tbWFuZCwgb3B0cz17fSkge1xuICAvLyB3ZSBvbmx5IHN1cHBvcnQgbW9iaWxlOiBzY3JvbGxcbiAgaWYgKG1vYmlsZUNvbW1hbmQgPT09ICdzY3JvbGwnKSB7XG4gICAgYXdhaXQgdGhpcy5tb2JpbGVTY3JvbGwob3B0cyk7XG4gIH0gZWxzZSBpZiAobW9iaWxlQ29tbWFuZCA9PT0gJ3ZpZXdwb3J0U2NyZWVuc2hvdCcpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QoKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25Db21tYW5kRXJyb3IoJ1Vua25vd24gY29tbWFuZCwgYWxsIHRoZSBtb2JpbGUgY29tbWFuZHMgZXhjZXB0IHNjcm9sbCBoYXZlIGJlZW4gcmVtb3ZlZC4nKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
