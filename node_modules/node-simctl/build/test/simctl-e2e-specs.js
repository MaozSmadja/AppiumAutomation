/* global it:true, describe:true*/
require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _libSimctlJs = require('../lib/simctl.js');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('simctl', function () {
  var DEVICE_NAME = 'iPhone 6';
  var MOCHA_TIMEOUT = 200000;
  this.timeout(MOCHA_TIMEOUT);

  var randName = undefined;
  var randDeviceUdid = null;
  var validSdks = [];

  before(function callee$1$0() {
    var devices, i, randNum, nameFound, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, list;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 2:
          devices = context$2$0.sent;

          validSdks = _lodash2['default'].keys(devices).sort(function (a, b) {
            return a - b;
          });

          if (validSdks.length) {
            context$2$0.next = 6;
            break;
          }

          throw new Error('No valid SDKs');

        case 6:
          console.log('Found valid SDKs: ' + validSdks.join(', ')); // eslint-disable-line no-console

          // need to find a random name that does not already exist
          // give it 5 tries
          i = 0;

        case 8:
          if (!(i < 5)) {
            context$2$0.next = 44;
            break;
          }

          randNum = parseInt(Math.random() * 100, 10);

          randName = 'device' + randNum;

          nameFound = false;
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$2$0.prev = 15;
          _iterator = _getIterator(_lodash2['default'].values(devices));

        case 17:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$2$0.next = 25;
            break;
          }

          list = _step.value;

          if (!_lodash2['default'].includes(_lodash2['default'].map(list, 'name'), randName)) {
            context$2$0.next = 22;
            break;
          }

          // need to find another random name
          nameFound = true;
          return context$2$0.abrupt('break', 25);

        case 22:
          _iteratorNormalCompletion = true;
          context$2$0.next = 17;
          break;

        case 25:
          context$2$0.next = 31;
          break;

        case 27:
          context$2$0.prev = 27;
          context$2$0.t0 = context$2$0['catch'](15);
          _didIteratorError = true;
          _iteratorError = context$2$0.t0;

        case 31:
          context$2$0.prev = 31;
          context$2$0.prev = 32;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 34:
          context$2$0.prev = 34;

          if (!_didIteratorError) {
            context$2$0.next = 37;
            break;
          }

          throw _iteratorError;

        case 37:
          return context$2$0.finish(34);

        case 38:
          return context$2$0.finish(31);

        case 39:
          if (nameFound) {
            context$2$0.next = 41;
            break;
          }

          return context$2$0.abrupt('break', 44);

        case 41:
          i++;
          context$2$0.next = 8;
          break;

        case 44:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[15, 27, 31, 39], [32,, 34, 38]]);
  });

  // eslint-disable-line curly
  it('should create a device', function callee$1$0() {
    var udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)(randName, DEVICE_NAME, _lodash2['default'].last(validSdks)));

        case 2:
          udid = context$2$0.sent;

          (typeof udid).should.equal('string');
          udid.length.should.equal(36);

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should get devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 2:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.include(randName);
          randDeviceUdid = sdkDevices.filter(function (d) {
            return d.name === randName;
          })[0].udid;

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should erase devices', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.eraseDevice)(randDeviceUdid, 16000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should delete devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(randDeviceUdid));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 4:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.not.include(randName);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should return a nice error for invalid usage', function callee$1$0() {
    var err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          err = null;
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('foo', 'bar', 'baz'));

        case 4:
          context$2$0.next = 9;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          err = context$2$0.t0;

        case 9:
          should.exist(err);
          err.message.should.include('Invalid device type: bar');

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[1, 6]]);
  });

  it('should create a device and be able to see it in devices list right away', function callee$1$0() {
    var sdk, numSimsBefore, udid, numSimsAfter;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          numSimsBefore = context$2$0.sent[context$2$0.t0].length;
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 7:
          udid = context$2$0.sent;
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 10:
          context$2$0.t1 = sdk;
          numSimsAfter = context$2$0.sent[context$2$0.t1].length;

          numSimsAfter.should.equal(numSimsBefore + 1);
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

        case 15:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should create a device with compatible properties', function callee$1$0() {
    var sdk, devices, firstDevice, expectedList;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          devices = context$2$0.sent[context$2$0.t0];
          firstDevice = devices[0];
          expectedList = ['name', 'sdk', 'state', 'udid'];

          _Object$keys(firstDevice).sort().should.eql(expectedList);

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should not fail to shutdown a shutdown simulator', function callee$1$0() {
    var sdk, udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 3:
          udid = context$2$0.sent;
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid).should.eventually.not.be.rejected);

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('on running Simulator', function () {
    if (process.env.TRAVIS) {
      this.retries(3);
    }

    var udid = undefined;
    var major = undefined,
        minor = undefined;

    before(function callee$2$0() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 2:
            _ref = context$3$0.sent;
            major = _ref.major;
            minor = _ref.minor;

            if (!(major < 8 || major === 8 && minor < 1)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 7:
            sdk = _lodash2['default'].last(validSdks);
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('runningSimTest', DEVICE_NAME, sdk));

          case 10:
            udid = context$3$0.sent;
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.bootDevice)(udid));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.launch)(udid, 'com.apple.springboard', MOCHA_TIMEOUT));

          case 15:
            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 17:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            if (!udid) {
              context$3$0.next = 10;
              break;
            }

            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid));

          case 4:
            context$3$0.next = 8;
            break;

          case 6:
            context$3$0.prev = 6;
            context$3$0.t0 = context$3$0['catch'](1);

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 6]]);
    });

    describe('pasteboard', function () {
      var pbRetries = 0;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              if (!(major === 9)) {
                context$4$0.next = 7;
                break;
              }

              if (!process.env.TRAVIS) {
                context$4$0.next = 5;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 5:
              // TODO: recheck when full Xcode 9 comes out to see if pasteboard works better
              pbRetries = 200;
              this.timeout(200 * 1000 * 2);

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should set and get the content of the pasteboard', function callee$3$0() {
        var pbContent, encoding;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          var _this = this;

          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              pbContent = 'blablabla';
              encoding = 'ascii';
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.setPasteboard)(udid, pbContent, encoding));

            case 4:
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(pbRetries, 1000, function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap((0, _libSimctlJs.getPasteboard)(udid, encoding));

                    case 2:
                      context$5$0.t0 = pbContent;
                      context$5$0.sent.should.eql(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this);
              }));

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    describe('add media', function () {
      var BASE64_PNG = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
      var picturePath = undefined;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'pixel', suffix: '.png' }));

            case 4:
              picturePath = context$4$0.sent;
              context$4$0.next = 7;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(picturePath, Buffer.from(BASE64_PNG, 'base64').toString('binary'), 'binary'));

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      after(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(picturePath));

            case 2:
              if (!context$4$0.sent) {
                context$4$0.next = 5;
                break;
              }

              context$4$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(picturePath));

            case 5:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should add media files', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.addMedia)(udid, picturePath));

            case 2:
              context$4$0.sent.code.should.eql(0);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    it('should extract applications information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.appInfo)(udid, 'com.apple.springboard'));

          case 2:
            context$3$0.sent.should.include('ApplicationType');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    describe('getDeviceTypes', function () {
      it('should get device types', function callee$3$0() {
        var deviceTypes;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.getDeviceTypes)());

            case 2:
              deviceTypes = context$4$0.sent;

              deviceTypes.should.have.length;
              deviceTypes.length.should.be.above(0);
              // at least one type, no matter the version of Xcode, should be an iPhone
              deviceTypes.filter(function (el) {
                return el.includes('iPhone');
              }).length.should.be.above(1);

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });
  });
});

// Wait for boot to complete

// pause a moment or everything is messed up
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc2ltY3RsLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O29CQUdpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztzQkFDL0IsUUFBUTs7OzsyQkFHUyxrQkFBa0I7OzJCQUMvQixjQUFjOzs7O3dCQUNsQixVQUFVOzs7OzZCQUNJLGdCQUFnQjs7d0JBQ2QsVUFBVTs7QUFHeEMsSUFBTSxNQUFNLEdBQUcsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDN0Isa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFZO0FBQzdCLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQztBQUMvQixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUM7QUFDN0IsTUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFNUIsTUFBSSxRQUFRLFlBQUEsQ0FBQztBQUNiLE1BQUksY0FBYyxHQUFHLElBQUksQ0FBQztBQUMxQixNQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7O0FBRW5CLFFBQU0sQ0FBQztRQUNELE9BQU8sRUFTRixDQUFDLEVBQ0osT0FBTyxFQUdQLFNBQVMsa0ZBQ0osSUFBSTs7Ozs7OzJDQWRLLDhCQUFZOzs7QUFBNUIsaUJBQU87O0FBQ1gsbUJBQVMsR0FBRyxvQkFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQyxFQUFFLENBQUM7bUJBQUssQ0FBQyxHQUFHLENBQUM7V0FBQSxDQUFDLENBQUM7O2NBQzdDLFNBQVMsQ0FBQyxNQUFNOzs7OztnQkFDYixJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUM7OztBQUVsQyxpQkFBTyxDQUFDLEdBQUcsd0JBQXNCLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUcsQ0FBQzs7OztBQUloRCxXQUFDLEdBQUcsQ0FBQzs7O2dCQUFFLENBQUMsR0FBRyxDQUFDLENBQUE7Ozs7O0FBQ2Ys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Q0FBQyxXQUFXLENBQUM7Ozs7Ozs7T0FFL0IsQ0FBQyxDQUFDO0FBQ0gsUUFBRSxDQUFDLHdCQUF3QixFQUFFOzs7OzsrQ0FDcEIsMkJBQVMsSUFBSSxFQUFFLFdBQVcsQ0FBQzs7OytCQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7Ozs7Ozs7T0FDdEQsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyx5Q0FBeUMsRUFBRTs7Ozs7NkNBQ3JDLDBCQUFRLElBQUksRUFBRSx1QkFBdUIsQ0FBQzs7OzZCQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsaUJBQWlCOzs7Ozs7O0tBQ2hGLENBQUMsQ0FBQzs7QUFFSCxZQUFRLENBQUMsZ0JBQWdCLEVBQUUsWUFBWTtBQUNyQyxRQUFFLENBQUMseUJBQXlCLEVBQUU7WUFDdEIsV0FBVzs7Ozs7K0NBQVMsa0NBQWdCOzs7QUFBcEMseUJBQVc7O0FBQ2pCLHlCQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDL0IseUJBQVcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRXRDLHlCQUFXLENBQUMsTUFBTSxDQUFDLFVBQUMsRUFBRTt1QkFBSyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztlQUFBLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7T0FDN0UsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3Qvc2ltY3RsLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBpdDp0cnVlLCBkZXNjcmliZTp0cnVlKi9cbi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBjcmVhdGVEZXZpY2UsIGRlbGV0ZURldmljZSwgZXJhc2VEZXZpY2UsIGdldERldmljZXMsIHNldFBhc3RlYm9hcmQsXG4gICAgICAgICBnZXRQYXN0ZWJvYXJkLCBib290RGV2aWNlLCBsYXVuY2gsIHNodXRkb3duLCBhZGRNZWRpYSwgYXBwSW5mbyxcbiAgICAgICAgIGdldERldmljZVR5cGVzIH0gZnJvbSAnLi4vbGliL3NpbWN0bC5qcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5kZXNjcmliZSgnc2ltY3RsJywgZnVuY3Rpb24gKCkge1xuICBjb25zdCBERVZJQ0VfTkFNRSA9ICdpUGhvbmUgNic7XG4gIGNvbnN0IE1PQ0hBX1RJTUVPVVQgPSAyMDAwMDA7XG4gIHRoaXMudGltZW91dChNT0NIQV9USU1FT1VUKTtcblxuICBsZXQgcmFuZE5hbWU7XG4gIGxldCByYW5kRGV2aWNlVWRpZCA9IG51bGw7XG4gIGxldCB2YWxpZFNka3MgPSBbXTtcblxuICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcygpO1xuICAgIHZhbGlkU2RrcyA9IF8ua2V5cyhkZXZpY2VzKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgaWYgKCF2YWxpZFNka3MubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIFNES3MnKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYEZvdW5kIHZhbGlkIFNES3M6ICR7dmFsaWRTZGtzLmpvaW4oJywgJyl9YCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuXG4gICAgLy8gbmVlZCB0byBmaW5kIGEgcmFuZG9tIG5hbWUgdGhhdCBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0XG4gICAgLy8gZ2l2ZSBpdCA1IHRyaWVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgIGxldCByYW5kTnVtID0gcGFyc2VJbnQoTWF0aC5yYW5kb20oKSAqIDEwMCwgMTApO1xuICAgICAgcmFuZE5hbWUgPSBgZGV2aWNlJHtyYW5kTnVtfWA7XG5cbiAgICAgIGxldCBuYW1lRm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAobGV0IGxpc3Qgb2YgXy52YWx1ZXMoZGV2aWNlcykpIHtcbiAgICAgICAgaWYgKF8uaW5jbHVkZXMoXy5tYXAobGlzdCwgJ25hbWUnKSwgcmFuZE5hbWUpKSB7XG4gICAgICAgICAgLy8gbmVlZCB0byBmaW5kIGFub3RoZXIgcmFuZG9tIG5hbWVcbiAgICAgICAgICBuYW1lRm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIW5hbWVGb3VuZCkgYnJlYWs7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY3JlYXRlIGEgZGV2aWNlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKHJhbmROYW1lLCBERVZJQ0VfTkFNRSwgXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgICh0eXBlb2YgdWRpZCkuc2hvdWxkLmVxdWFsKCdzdHJpbmcnKTtcbiAgICB1ZGlkLmxlbmd0aC5zaG91bGQuZXF1YWwoMzYpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGdldCBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGtEZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcyhfLmxhc3QodmFsaWRTZGtzKSk7XG4gICAgXy5tYXAoc2RrRGV2aWNlcywgJ25hbWUnKS5zaG91bGQuaW5jbHVkZShyYW5kTmFtZSk7XG4gICAgcmFuZERldmljZVVkaWQgPSBzZGtEZXZpY2VzLmZpbHRlcigoZCkgPT4gZC5uYW1lID09PSByYW5kTmFtZSlbMF0udWRpZDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBlcmFzZSBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGVyYXNlRGV2aWNlKHJhbmREZXZpY2VVZGlkLCAxNjAwMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZGVsZXRlIGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgZGVsZXRlRGV2aWNlKHJhbmREZXZpY2VVZGlkKTtcbiAgICBsZXQgc2RrRGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMoXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgIF8ubWFwKHNka0RldmljZXMsICduYW1lJykuc2hvdWxkLm5vdC5pbmNsdWRlKHJhbmROYW1lKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYSBuaWNlIGVycm9yIGZvciBpbnZhbGlkIHVzYWdlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBlcnIgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjcmVhdGVEZXZpY2UoJ2ZvbycsICdiYXInLCAnYmF6Jyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXJyID0gZTtcbiAgICB9XG4gICAgc2hvdWxkLmV4aXN0KGVycik7XG4gICAgZXJyLm1lc3NhZ2Uuc2hvdWxkLmluY2x1ZGUoJ0ludmFsaWQgZGV2aWNlIHR5cGU6IGJhcicpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSBhbmQgYmUgYWJsZSB0byBzZWUgaXQgaW4gZGV2aWNlcyBsaXN0IHJpZ2h0IGF3YXknLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNkayA9IF8ubGFzdCh2YWxpZFNka3MpO1xuICAgIGxldCBudW1TaW1zQmVmb3JlID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbGV0IHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ25vZGUtc2ltY3RsIHRlc3QnLCBERVZJQ0VfTkFNRSwgc2RrKTtcbiAgICBsZXQgbnVtU2ltc0FmdGVyID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbnVtU2ltc0FmdGVyLnNob3VsZC5lcXVhbChudW1TaW1zQmVmb3JlICsgMSk7XG4gICAgYXdhaXQgZGVsZXRlRGV2aWNlKHVkaWQpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSB3aXRoIGNvbXBhdGlibGUgcHJvcGVydGllcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2RrID0gXy5sYXN0KHZhbGlkU2Rrcyk7XG4gICAgbGV0IGRldmljZXMgPSAoYXdhaXQgZ2V0RGV2aWNlcygpKVtzZGtdO1xuICAgIGxldCBmaXJzdERldmljZSA9IGRldmljZXNbMF07XG4gICAgbGV0IGV4cGVjdGVkTGlzdCA9IFsnbmFtZScsICdzZGsnLCAnc3RhdGUnLCAndWRpZCddO1xuICAgIE9iamVjdC5rZXlzKGZpcnN0RGV2aWNlKS5zb3J0KCkuc2hvdWxkLmVxbChleHBlY3RlZExpc3QpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIG5vdCBmYWlsIHRvIHNodXRkb3duIGEgc2h1dGRvd24gc2ltdWxhdG9yJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICBsZXQgdWRpZCA9IGF3YWl0IGNyZWF0ZURldmljZSgnbm9kZS1zaW1jdGwgdGVzdCcsIERFVklDRV9OQU1FLCBzZGspO1xuICAgIGF3YWl0IHNodXRkb3duKHVkaWQpLnNob3VsZC5ldmVudHVhbGx5Lm5vdC5iZS5yZWplY3RlZDtcbiAgICBhd2FpdCBkZWxldGVEZXZpY2UodWRpZCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdvbiBydW5uaW5nIFNpbXVsYXRvcicsIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgICB0aGlzLnJldHJpZXMoMyk7XG4gICAgfVxuXG4gICAgbGV0IHVkaWQ7XG4gICAgbGV0IG1ham9yLCBtaW5vcjtcblxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoe21ham9yLCBtaW5vcn0gPSBhd2FpdCB4Y29kZS5nZXRWZXJzaW9uKHRydWUpKTtcbiAgICAgIGlmIChtYWpvciA8IDggfHwgKG1ham9yID09PSA4ICYmIG1pbm9yIDwgMSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICAgIHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ3J1bm5pbmdTaW1UZXN0JywgREVWSUNFX05BTUUsIHNkayk7XG5cbiAgICAgIGF3YWl0IGJvb3REZXZpY2UodWRpZCk7XG4gICAgICAvLyBXYWl0IGZvciBib290IHRvIGNvbXBsZXRlXG4gICAgICBhd2FpdCBsYXVuY2godWRpZCwgJ2NvbS5hcHBsZS5zcHJpbmdib2FyZCcsIE1PQ0hBX1RJTUVPVVQpO1xuXG4gICAgICAvLyBwYXVzZSBhIG1vbWVudCBvciBldmVyeXRoaW5nIGlzIG1lc3NlZCB1cFxuICAgICAgYXdhaXQgQi5kZWxheSg1MDAwKTtcbiAgICB9KTtcbiAgICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAodWRpZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHNodXRkb3duKHVkaWQpO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIGF3YWl0IGRlbGV0ZURldmljZSh1ZGlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdwYXN0ZWJvYXJkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHBiUmV0cmllcyA9IDA7XG4gICAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYWpvciA9PT0gOSkge1xuICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5UUkFWSVMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gVE9ETzogcmVjaGVjayB3aGVuIGZ1bGwgWGNvZGUgOSBjb21lcyBvdXQgdG8gc2VlIGlmIHBhc3RlYm9hcmQgd29ya3MgYmV0dGVyXG4gICAgICAgICAgcGJSZXRyaWVzID0gMjAwO1xuICAgICAgICAgIHRoaXMudGltZW91dCgyMDAgKiAxMDAwICogMik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBzZXQgYW5kIGdldCB0aGUgY29udGVudCBvZiB0aGUgcGFzdGVib2FyZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgcGJDb250ZW50ID0gJ2JsYWJsYWJsYSc7XG4gICAgICAgIGNvbnN0IGVuY29kaW5nID0gJ2FzY2lpJztcblxuICAgICAgICBhd2FpdCBzZXRQYXN0ZWJvYXJkKHVkaWQsIHBiQ29udGVudCwgZW5jb2RpbmcpO1xuICAgICAgICBhd2FpdCByZXRyeUludGVydmFsKHBiUmV0cmllcywgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIChhd2FpdCBnZXRQYXN0ZWJvYXJkKHVkaWQsIGVuY29kaW5nKSkuc2hvdWxkLmVxbChwYkNvbnRlbnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2FkZCBtZWRpYScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IEJBU0U2NF9QTkcgPSAnaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUFFQUFBQUJDQVlBQUFBZkZjU0pBQUFBRFVsRVFWUjQybU5rK005UUR3QURoZ0dBV2pSOWF3QUFBQUJKUlU1RXJrSmdnZz09JztcbiAgICAgIGxldCBwaWN0dXJlUGF0aDtcbiAgICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChtYWpvciA8IDggfHwgKG1ham9yID09PSA4ICYmIG1pbm9yIDwgMSkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgICAgIH1cbiAgICAgICAgcGljdHVyZVBhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe3ByZWZpeDogJ3BpeGVsJywgc3VmZml4OiAnLnBuZyd9KTtcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKHBpY3R1cmVQYXRoLCBCdWZmZXIuZnJvbShCQVNFNjRfUE5HLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpLCAnYmluYXJ5Jyk7XG4gICAgICB9KTtcbiAgICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhwaWN0dXJlUGF0aCkpIHtcbiAgICAgICAgICBhd2FpdCBmcy51bmxpbmsocGljdHVyZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYWRkIG1lZGlhIGZpbGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAoYXdhaXQgYWRkTWVkaWEodWRpZCwgcGljdHVyZVBhdGgpKS5jb2RlLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBhcHBsaWNhdGlvbnMgaW5mb3JtYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoYXdhaXQgYXBwSW5mbyh1ZGlkLCAnY29tLmFwcGxlLnNwcmluZ2JvYXJkJykpLnNob3VsZC5pbmNsdWRlKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdnZXREZXZpY2VUeXBlcycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGl0KCdzaG91bGQgZ2V0IGRldmljZSB0eXBlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgZGV2aWNlVHlwZXMgPSBhd2FpdCBnZXREZXZpY2VUeXBlcygpO1xuICAgICAgICBkZXZpY2VUeXBlcy5zaG91bGQuaGF2ZS5sZW5ndGg7XG4gICAgICAgIGRldmljZVR5cGVzLmxlbmd0aC5zaG91bGQuYmUuYWJvdmUoMCk7XG4gICAgICAgIC8vIGF0IGxlYXN0IG9uZSB0eXBlLCBubyBtYXR0ZXIgdGhlIHZlcnNpb24gb2YgWGNvZGUsIHNob3VsZCBiZSBhbiBpUGhvbmVcbiAgICAgICAgZGV2aWNlVHlwZXMuZmlsdGVyKChlbCkgPT4gZWwuaW5jbHVkZXMoJ2lQaG9uZScpKS5sZW5ndGguc2hvdWxkLmJlLmFib3ZlKDEpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
