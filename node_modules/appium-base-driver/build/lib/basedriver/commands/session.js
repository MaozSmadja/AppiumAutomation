'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _protocol = require('../../protocol');

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var _capabilities = require('../capabilities');

var commands = {};

commands.createSession = function callee$0$0(jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  var caps;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(this.sessionId !== null)) {
          context$1$0.next = 2;
          break;
        }

        throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');

      case 2:

        _logger2['default'].debug();

        // Determine weather we should use jsonwpDesiredCapabilities or w3cCapabilities to get caps from
        caps = undefined;

        if (w3cCapabilities) {
          this.setProtocolW3C();
          if (jsonwpDesiredCapabilities) {
            _logger2['default'].debug('W3C capabilities ' + _lodash2['default'].truncate(JSON.stringify(w3cCapabilities)) + ' and MJSONWP desired capabilities ' + _lodash2['default'].truncate(JSON.stringify(jsonwpDesiredCapabilities)) + ' were provided');
          }

          if (jsonwpDesiredCapabilities && !_lodash2['default'].isPlainObject(w3cCapabilities)) {
            // If W3C Capabilities and MJSONWP Capabilities were provided and W3C caps aren't a plain object,
            // log a warning and fall back to MJSONWP
            if (!_lodash2['default'].isEmpty(w3cCapabilities)) {
              _logger2['default'].warn('Expected W3C "capabilities" to be a JSON Object but was provided with: ' + JSON.stringify(w3cCapabilities));
            }
            _logger2['default'].warn('Falling back to MJSONWP desired capabilities');
            this.setProtocolMJSONWP();
            caps = jsonwpDesiredCapabilities;
          } else {
            _logger2['default'].debug('Creating session with W3C capabilities: ' + _lodash2['default'].truncate(JSON.stringify(w3cCapabilities)));
            caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
          }
        } else {
          this.setProtocolMJSONWP();
          _logger2['default'].debug('Creating session with MJSONWP desired capabilities: ' + _lodash2['default'].truncate(JSON.stringify(jsonwpDesiredCapabilities)));
          caps = jsonwpDesiredCapabilities || {};
        }

        caps = fixCaps(caps, this.desiredCapConstraints);
        this.validateDesiredCaps(caps);

        this.sessionId = _uuidJs2['default'].create().hex;
        this.caps = caps;
        this.opts = _lodash2['default'].cloneDeep(this.initialOpts);

        // merge caps onto opts so we don't need to worry about what's where
        _Object$assign(this.opts, this.caps);

        // deal with resets
        // some people like to do weird things by setting noReset and fullReset
        // both to true, but this is misguided and strange, so error here instead

        if (!(this.opts.noReset && this.opts.fullReset)) {
          context$1$0.next = 13;
          break;
        }

        throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + "exclusive and should not both be set to true. You " + "probably meant to just use 'fullReset' on its own");

      case 13:
        if (this.opts.noReset === true) {
          this.opts.fullReset = false;
        }
        if (this.opts.fullReset === true) {
          this.opts.noReset = false;
        }
        this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
        this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

        // Prevents empty string caps so we don't need to test it everywhere
        if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
          this.opts.app = null;
        }

        if (!_lodash2['default'].isUndefined(this.caps.newCommandTimeout)) {
          this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
        }

        // We need to ininitialize one onUnexpectedShutdow promise per session
        // to avoid the promise fulfilment being propagated between sessions.
        this.resetOnUnexpectedShutdown();

        _logger2['default'].info('Session created with session id: ' + this.sessionId);

        return context$1$0.abrupt('return', [this.sessionId, caps]);

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getSessions = function callee$0$0() {
  var ret;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        ret = [];

        if (this.sessionId) {
          ret.push({
            id: this.sessionId,
            capabilities: this.caps
          });
        }

        return context$1$0.abrupt('return', ret);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getSession = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.caps.eventTimings) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', _Object$assign({}, this.caps, { events: this.eventHistory }));

      case 2:
        return context$1$0.abrupt('return', this.caps);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.deleteSession = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        this.clearNewCommandTimeout();
        this.sessionId = null;

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function fixCaps(originalCaps) {
  var desiredCapConstraints = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var caps = _lodash2['default'].clone(originalCaps);

  // boolean capabilities can be passed in as strings 'false' and 'true'
  // which we want to translate into boolean values
  var booleanCaps = _lodash2['default'].keys(_lodash2['default'].pickBy(desiredCapConstraints, function (k) {
    return k.isBoolean === true;
  }));
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(booleanCaps), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var cap = _step.value;

      var value = originalCaps[cap];
      if (_lodash2['default'].isString(value)) {
        value = value.toLowerCase();
        if (value === 'true' || value === 'false') {
          _logger2['default'].warn('Capability \'' + cap + '\' changed from string to boolean. This may cause unexpected behavior');
          caps[cap] = value === 'true';
        }
      }
    }

    // int capabilities are often sent in as strings by frameworks
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  var intCaps = _lodash2['default'].keys(_lodash2['default'].pickBy(desiredCapConstraints, function (k) {
    return k.isNumber === true;
  }));
  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = _getIterator(intCaps), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      var cap = _step2.value;

      var value = originalCaps[cap];
      if (_lodash2['default'].isString(value)) {
        var newValue = parseInt(value, 10);
        if (value.indexOf('.') !== -1) {
          newValue = parseFloat(value);
        }
        _logger2['default'].warn('Capability \'' + cap + '\' changed from string (\'' + value + '\') to integer (' + newValue + '). This may cause unexpected behavior');
        caps[cap] = newValue;
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2['return']) {
        _iterator2['return']();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }

  return caps;
}

exports['default'] = commands;
module.exports = exports['default'];
/* sessionId */
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7OztzQkFDTixXQUFXOzs7O3dCQUNKLGdCQUFnQjs7c0JBQ3RCLFNBQVM7Ozs7NEJBQ1UsaUJBQWlCOztBQUVyRCxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7O0FBRWxCLFFBQVEsQ0FBQyxhQUFhLEdBQUcsb0JBQWdCLHlCQUF5QixFQUFFLGtCQUFrQixFQUFFLGVBQWU7TUFTakcsSUFBSTs7OztjQVJKLElBQUksQ0FBQyxTQUFTLEtBQUssSUFBSSxDQUFBOzs7OztjQUNuQixJQUFJLGlCQUFPLHNCQUFzQixDQUFDLDhCQUE4QixHQUM5QiwwQkFBMEIsQ0FBQzs7OztBQUdyRSw0QkFBSSxLQUFLLEVBQUUsQ0FBQzs7O0FBR1IsWUFBSTs7QUFDUixZQUFJLGVBQWUsRUFBRTtBQUNuQixjQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDdEIsY0FBSSx5QkFBeUIsRUFBRTtBQUM3QixnQ0FBSSxLQUFLLHVCQUFxQixvQkFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQywwQ0FBcUMsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQyxvQkFBaUIsQ0FBQztXQUN0TDs7QUFFRCxjQUFJLHlCQUF5QixJQUFJLENBQUMsb0JBQUUsYUFBYSxDQUFDLGVBQWUsQ0FBQyxFQUFFOzs7QUFHbEUsZ0JBQUksQ0FBQyxvQkFBRSxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUU7QUFDL0Isa0NBQUksSUFBSSw2RUFBMkUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBRyxDQUFDO2FBQ3ZIO0FBQ0QsZ0NBQUksSUFBSSxnREFBZ0QsQ0FBQztBQUN6RCxnQkFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7QUFDMUIsZ0JBQUksR0FBRyx5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bUJBQWdCLEdBQUcsMkVBQXVFLENBQUM7QUFDbkcsY0FBSSxDQUFDLEdBQUcsQ0FBQyxHQUFJLEtBQUssS0FBSyxNQUFNLEFBQUMsQ0FBQztTQUNoQztPQUNGO0tBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUdELE1BQUksT0FBTyxHQUFHLG9CQUFFLElBQUksQ0FBQyxvQkFBRSxNQUFNLENBQUMscUJBQXFCLEVBQUUsVUFBQyxDQUFDO1dBQUssQ0FBQyxDQUFDLFFBQVEsS0FBSyxJQUFJO0dBQUEsQ0FBQyxDQUFDLENBQUM7Ozs7OztBQUNsRix1Q0FBZ0IsT0FBTyxpSEFBRTtVQUFoQixHQUFHOztBQUNWLFVBQUksS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM5QixVQUFJLG9CQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNyQixZQUFJLFFBQVEsR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ25DLFlBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtBQUM3QixrQkFBUSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM5QjtBQUNELDRCQUFJLElBQUksbUJBQWdCLEdBQUcsa0NBQTJCLEtBQUssd0JBQWtCLFFBQVEsMkNBQXdDLENBQUM7QUFDOUgsWUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQztPQUN0QjtLQUNGOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUQsU0FBTyxJQUFJLENBQUM7Q0FDYjs7cUJBRWMsUUFBUSIsImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy9zZXNzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uL3Byb3RvY29sJztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IHsgcHJvY2Vzc0NhcGFiaWxpdGllcyB9IGZyb20gJy4uL2NhcGFiaWxpdGllcyc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5jcmVhdGVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMsIGpzb253cFJlcXVpcmVkQ2FwcywgdzNjQ2FwYWJpbGl0aWVzKSB7XG4gIGlmICh0aGlzLnNlc3Npb25JZCAhPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcignQ2Fubm90IGNyZWF0ZSBhIG5ldyBzZXNzaW9uICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2hpbGUgb25lIGlzIGluIHByb2dyZXNzJyk7XG4gIH1cblxuICBsb2cuZGVidWcoKTtcblxuICAvLyBEZXRlcm1pbmUgd2VhdGhlciB3ZSBzaG91bGQgdXNlIGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgb3IgdzNjQ2FwYWJpbGl0aWVzIHRvIGdldCBjYXBzIGZyb21cbiAgbGV0IGNhcHM7XG4gIGlmICh3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICB0aGlzLnNldFByb3RvY29sVzNDKCk7XG4gICAgaWYgKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVzNDIGNhcGFiaWxpdGllcyAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkodzNjQ2FwYWJpbGl0aWVzKSl9IGFuZCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzKSl9IHdlcmUgcHJvdmlkZWRgKTtcbiAgICB9XG5cbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcyAmJiAhXy5pc1BsYWluT2JqZWN0KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgIC8vIElmIFczQyBDYXBhYmlsaXRpZXMgYW5kIE1KU09OV1AgQ2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWQgYW5kIFczQyBjYXBzIGFyZW4ndCBhIHBsYWluIG9iamVjdCxcbiAgICAgIC8vIGxvZyBhIHdhcm5pbmcgYW5kIGZhbGwgYmFjayB0byBNSlNPTldQXG4gICAgICBpZiAoIV8uaXNFbXB0eSh3M2NDYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgIGxvZy53YXJuKGBFeHBlY3RlZCBXM0MgXCJjYXBhYmlsaXRpZXNcIiB0byBiZSBhIEpTT04gT2JqZWN0IGJ1dCB3YXMgcHJvdmlkZWQgd2l0aDogJHtKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpfWApO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzYCk7XG4gICAgICB0aGlzLnNldFByb3RvY29sTUpTT05XUCgpO1xuICAgICAgY2FwcyA9IGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIFczQyBjYXBhYmlsaXRpZXM6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpKX1gKTtcbiAgICAgIGNhcHMgPSBwcm9jZXNzQ2FwYWJpbGl0aWVzKHczY0NhcGFiaWxpdGllcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMsIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5zZXRQcm90b2NvbE1KU09OV1AoKTtcbiAgICBsb2cuZGVidWcoYENyZWF0aW5nIHNlc3Npb24gd2l0aCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcykpfWApO1xuICAgIGNhcHMgPSBqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzIHx8IHt9O1xuICB9XG5cbiAgY2FwcyA9IGZpeENhcHMoY2FwcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMpO1xuICB0aGlzLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG5cbiAgdGhpcy5zZXNzaW9uSWQgPSBVVUlELmNyZWF0ZSgpLmhleDtcbiAgdGhpcy5jYXBzID0gY2FwcztcbiAgdGhpcy5vcHRzID0gXy5jbG9uZURlZXAodGhpcy5pbml0aWFsT3B0cyk7XG5cbiAgLy8gbWVyZ2UgY2FwcyBvbnRvIG9wdHMgc28gd2UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB3aGF0J3Mgd2hlcmVcbiAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIHRoaXMuY2Fwcyk7XG5cbiAgLy8gZGVhbCB3aXRoIHJlc2V0c1xuICAvLyBzb21lIHBlb3BsZSBsaWtlIHRvIGRvIHdlaXJkIHRoaW5ncyBieSBzZXR0aW5nIG5vUmVzZXQgYW5kIGZ1bGxSZXNldFxuICAvLyBib3RoIHRvIHRydWUsIGJ1dCB0aGlzIGlzIG1pc2d1aWRlZCBhbmQgc3RyYW5nZSwgc28gZXJyb3IgaGVyZSBpbnN0ZWFkXG4gIGlmICh0aGlzLm9wdHMubm9SZXNldCAmJiB0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlICdub1Jlc2V0JyBhbmQgJ2Z1bGxSZXNldCcgY2FwYWJpbGl0aWVzIGFyZSBtdXR1YWxseSBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwiZXhjbHVzaXZlIGFuZCBzaG91bGQgbm90IGJvdGggYmUgc2V0IHRvIHRydWUuIFlvdSBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwicHJvYmFibHkgbWVhbnQgdG8ganVzdCB1c2UgJ2Z1bGxSZXNldCcgb24gaXRzIG93blwiKTtcbiAgfVxuICBpZiAodGhpcy5vcHRzLm5vUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gZmFsc2U7XG4gIH1cbiAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMubm9SZXNldCA9IGZhbHNlO1xuICB9XG4gIHRoaXMub3B0cy5mYXN0UmVzZXQgPSAhdGhpcy5vcHRzLmZ1bGxSZXNldCAmJiAhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gIHRoaXMub3B0cy5za2lwVW5pbnN0YWxsID0gdGhpcy5vcHRzLmZhc3RSZXNldCB8fCB0aGlzLm9wdHMubm9SZXNldDtcblxuICAvLyBQcmV2ZW50cyBlbXB0eSBzdHJpbmcgY2FwcyBzbyB3ZSBkb24ndCBuZWVkIHRvIHRlc3QgaXQgZXZlcnl3aGVyZVxuICBpZiAodHlwZW9mIHRoaXMub3B0cy5hcHAgPT09ICdzdHJpbmcnICYmIHRoaXMub3B0cy5hcHAudHJpbSgpID09PSAnJykge1xuICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICB9XG5cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuY2Fwcy5uZXdDb21tYW5kVGltZW91dCkpIHtcbiAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSAodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0ICogMTAwMCk7XG4gIH1cblxuICAvLyBXZSBuZWVkIHRvIGluaW5pdGlhbGl6ZSBvbmUgb25VbmV4cGVjdGVkU2h1dGRvdyBwcm9taXNlIHBlciBzZXNzaW9uXG4gIC8vIHRvIGF2b2lkIHRoZSBwcm9taXNlIGZ1bGZpbG1lbnQgYmVpbmcgcHJvcGFnYXRlZCBiZXR3ZWVuIHNlc3Npb25zLlxuICB0aGlzLnJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24oKTtcblxuICBsb2cuaW5mbyhgU2Vzc2lvbiBjcmVhdGVkIHdpdGggc2Vzc2lvbiBpZDogJHt0aGlzLnNlc3Npb25JZH1gKTtcblxuICByZXR1cm4gW3RoaXMuc2Vzc2lvbklkLCBjYXBzXTtcbn07XG5cbmNvbW1hbmRzLmdldFNlc3Npb25zID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgcmV0ID0gW107XG5cbiAgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgcmV0LnB1c2goe1xuICAgICAgaWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB0aGlzLmNhcHNcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXQ7XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5jYXBzLmV2ZW50VGltaW5ncykge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmNhcHMsIHtldmVudHM6IHRoaXMuZXZlbnRIaXN0b3J5fSk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuY2Fwcztcbn07XG5cbmNvbW1hbmRzLmRlbGV0ZVNlc3Npb24gPSBhc3luYyBmdW5jdGlvbiAoLyogc2Vzc2lvbklkICovKSB7XG4gIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICB0aGlzLnNlc3Npb25JZCA9IG51bGw7XG59O1xuXG5mdW5jdGlvbiBmaXhDYXBzIChvcmlnaW5hbENhcHMsIGRlc2lyZWRDYXBDb25zdHJhaW50cyA9IHt9KSB7XG4gIGxldCBjYXBzID0gXy5jbG9uZShvcmlnaW5hbENhcHMpO1xuXG4gIC8vIGJvb2xlYW4gY2FwYWJpbGl0aWVzIGNhbiBiZSBwYXNzZWQgaW4gYXMgc3RyaW5ncyAnZmFsc2UnIGFuZCAndHJ1ZSdcbiAgLy8gd2hpY2ggd2Ugd2FudCB0byB0cmFuc2xhdGUgaW50byBib29sZWFuIHZhbHVlc1xuICBsZXQgYm9vbGVhbkNhcHMgPSBfLmtleXMoXy5waWNrQnkoZGVzaXJlZENhcENvbnN0cmFpbnRzLCAoaykgPT4gay5pc0Jvb2xlYW4gPT09IHRydWUpKTtcbiAgZm9yIChsZXQgY2FwIG9mIGJvb2xlYW5DYXBzKSB7XG4gICAgbGV0IHZhbHVlID0gb3JpZ2luYWxDYXBzW2NhcF07XG4gICAgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAodmFsdWUgPT09ICd0cnVlJyB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJykge1xuICAgICAgICBsb2cud2FybihgQ2FwYWJpbGl0eSAnJHtjYXB9JyBjaGFuZ2VkIGZyb20gc3RyaW5nIHRvIGJvb2xlYW4uIFRoaXMgbWF5IGNhdXNlIHVuZXhwZWN0ZWQgYmVoYXZpb3JgKTtcbiAgICAgICAgY2Fwc1tjYXBdID0gKHZhbHVlID09PSAndHJ1ZScpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGludCBjYXBhYmlsaXRpZXMgYXJlIG9mdGVuIHNlbnQgaW4gYXMgc3RyaW5ncyBieSBmcmFtZXdvcmtzXG4gIGxldCBpbnRDYXBzID0gXy5rZXlzKF8ucGlja0J5KGRlc2lyZWRDYXBDb25zdHJhaW50cywgKGspID0+IGsuaXNOdW1iZXIgPT09IHRydWUpKTtcbiAgZm9yIChsZXQgY2FwIG9mIGludENhcHMpIHtcbiAgICBsZXQgdmFsdWUgPSBvcmlnaW5hbENhcHNbY2FwXTtcbiAgICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgIGxldCBuZXdWYWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgICBpZiAodmFsdWUuaW5kZXhPZignLicpICE9PSAtMSkge1xuICAgICAgICBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyAoJyR7dmFsdWV9JykgdG8gaW50ZWdlciAoJHtuZXdWYWx1ZX0pLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICBjYXBzW2NhcF0gPSBuZXdWYWx1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2Fwcztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
